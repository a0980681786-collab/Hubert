<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 GIS ç±ƒçƒç¤¾æ­²æœ«å¹´çµ‚æŠ½ç</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body { 
            font-family: 'Microsoft JhengHei', sans-serif; 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            display: flex;
            gap: 20px;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        .left-panel {
            flex: 1;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .right-panel {
            flex: 1;
            max-width: 600px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        /* âœ… éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• & è¨­å®šæŒ‰éˆ• */
        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        #soundToggle, #settingsBtn {
            background: rgba(255,193,7,0.9);
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        #soundToggle:hover, #settingsBtn:hover {
            background: rgba(255,193,7,1);
            transform: scale(1.05);
        }
        #soundToggle.muted {
            background: rgba(149,165,166,0.9);
            color: white;
        }
        #settingsBtn {
            background: rgba(52,152,219,0.9);
            color: white;
        }
        #settingsBtn:hover {
            background: rgba(52,152,219,1);
        }
        
        #topWinner { 
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            font-size: 32px; 
            padding: 20px 40px; 
            background: linear-gradient(45deg, rgba(255,215,0,0.9), rgba(255,140,0,0.9)); 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 350px;
            font-weight: bold;
            display: none;
            animation: bounce 0.6s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-20px); }
            60% { transform: translateX(-50%) translateY(-10px); }
        }
        
        #lotteryBox {
            width: 350px !important;
            height: 350px !important;
            margin: 100px auto !important;
            position: relative;
            perspective: 800px;
        }
        .box-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.6s;
        }
        .box {
            width: 220px;
            height: 220px;
            position: absolute;
            left: 65px;
            top: 65px;
            background: linear-gradient(145deg, #d4a574, #b8860b);
            border: 8px solid #8B4513;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.5),
                inset 0 10px 20px rgba(255,255,255,0.2);
        }
        .box-lid {
            width: 236px;
            height: 130px;
            position: absolute;
            left: 57px;
            top: -65px;
            background: linear-gradient(145deg, #e6b885, #cd853f);
            border: 8px solid #A0522D;
            border-radius: 20px 20px 12px 12px;
            transform-origin: bottom;
            box-shadow: 
                0 12px 25px rgba(0,0,0,0.4),
                inset 0 6px 12px rgba(255,255,255,0.3);
            transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .nameCard {
            position: absolute;
            width: 100px;
            height: 50px;
            background: linear-gradient(45deg, #fff, #f8f8f8);
            border: 2px solid #ffd700;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #d32f2f;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            opacity: 0;
            z-index: 100;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
        }
        
        @keyframes shakeIntense {
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
            10% { transform: translate(-8px, -8px) rotate(-4deg) scale(1.02); }
            20% { transform: translate(10px, 6px) rotate(3deg) scale(0.98); }
            30% { transform: translate(-6px, 10px) rotate(-2deg) scale(1.01); }
            40% { transform: translate(12px, -5px) rotate(4deg) scale(0.99); }
            50% { transform: translate(-10px, 8px) rotate(-3deg) scale(1.03); }
            60% { transform: translate(8px, -6px) rotate(2deg) scale(0.97); }
            70% { transform: translate(-5px, 12px) rotate(-5deg) scale(1.02); }
            80% { transform: translate(15px, -3px) rotate(3deg) scale(0.98); }
            90% { transform: translate(-12px, 5px) rotate(-4deg) scale(1.01); }
        }
        @keyframes shakeLid {
            0%, 100% { transform: rotateX(0deg); }
            25% { transform: rotateX(6deg); }
            50% { transform: rotateX(-4deg); }
            75% { transform: rotateX(5deg); }
        }
        @keyframes openLid {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(-135deg); }
        }
        @keyframes flyOutBatch {
            0% { 
                transform: translate(-50%, -50%) rotate(0deg) scale(0.3); 
                opacity: 0; 
            }
            15% { 
                transform: translate(-50%, -50%) rotate(180deg) scale(1.1); 
                opacity: 1; 
            }
            100% { 
                transform: translate(var(--x-offset), var(--y-offset)) rotate(720deg) scale(1); 
                opacity: 0; 
            }
        }
        
        .shaking { animation: shakeIntense 0.08s ease-in-out infinite !important; }
        .shaking-lid { animation: shakeLid 0.12s ease-in-out infinite !important; }
        .opening { animation: openLid 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards !important; }
        .fly-out-batch { 
            animation: flyOutBatch 2s ease-out forwards !important; 
        }

        #currentWinner { 
            font-size: 20px; margin: 15px; padding: 15px; 
            background: rgba(255,255,255,0.2); border-radius: 10px; 
            min-height: 50px;
            text-align: center;
        }
        #batchWinners { 
            font-size: 18px; margin: 15px; padding: 15px; 
            background: rgba(0,255,0,0.4); border-radius: 10px; 
            text-align: left; max-height: 300px; overflow-y: auto;
            display: none;
        }
        .control-panel { 
            margin: 20px 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .button-group { 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .end-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #winnersList { 
            background: rgba(0,255,0,0.3); 
            padding: 20px; 
            border-radius: 15px;
            text-align: left;
            max-height: 600px; 
            overflow-y: auto;
            margin-top: 10px;
        }
        #exportBtn {
            background: #e74c3c !important;
            margin: 5px;
            padding: 12px 25px !important;
            font-size: 16px !important;
            min-width: 120px;
        }
        #exportBtn:hover {
            background: #c0392b !important;
            transform: scale(1.05);
        }
        button { 
            color: white; border: none; padding: 12px 25px; 
            font-size: 16px; border-radius: 30px; cursor: pointer; 
            transition: all 0.3s; font-weight: bold;
        }
        button:hover:not(:disabled) { transform: scale(1.05); }
        button:disabled { cursor: not-allowed; transform: none; opacity: 0.6; }
        .draw1 { background: #ff6b6b; }
        .draw1:hover:not(:disabled) { background: #ff5252; }
        .draw5 { background: #4ecdc4; }
        .draw5:hover:not(:disabled) { background: #45b7aa; }
        .draw30 { background: #9b59b6; }
        .draw30:hover:not(:disabled) { background: #8e44ad; }
        .end { background: #f39c12; }
        .end:hover:not(:disabled) { background: #e67e22; }
        .reset { background: #95a5a6; }
        .reset:hover:not(:disabled) { background: #7f8c8d; }
        .confirm-btn { background: #17a2b8; }
        .confirm-btn:hover:not(:disabled) { background: #138496; }
        input[type=file], input[type="number"], input[type="text"] { 
            margin: 10px; padding: 10px; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.9); color: #333; font-size: 16px;
        }
        input:focus { outline: none; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .batch-winner, .winner-item {
            margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.9); 
            border-radius: 8px; font-size: 16px; color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .winner-item.removeable {
            background: rgba(255, 165, 0, 0.6) !important;    
            border: 2px solid #ff8c00 !important;             
            color: #ffffff !important;                       
            font-size: 22px !important;                     
        }
        .winner-item.removeable span {
            color: #ffffff !important;
            font-size: 22px !important;
        }
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
        }
        .remove-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1 {
            margin: 20px 0;
            font-size: 28px;
            text-align: center;
        }
        h3 {
            margin: 0 0 15px 0;
            color: #fff;
        }

        /* âœ… è¨­å®šé¢æ¿ - å½ˆå‡ºè¦–çª— */
        #settingsDialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .settings-title {
            text-align: center;
            margin: 0 0 20px 0;
            color: #ffd700;
        }
        .settings-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .settings-yes { background: #28a745; }
        .settings-no { background: #dc3545; }
        .settings-yes:hover { background: #218838; }
        .settings-no:hover { background: #c82333; }

        /* âœ… ç¢ºèªè¦–çª—æ¨£å¼ */
        #confirmDialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .confirm-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .manual-input-area {
            margin-bottom: 20px; 
            padding: 15px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px;
            display: flex;
            gap: 10px;
        }
        .confirm-list {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .confirm-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            font-size: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .confirm-delete-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 6px 10px !important;
            border-radius: 50% !important;
            font-size: 14px !important;
            cursor: pointer !important;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }
        .confirm-delete-btn:hover {
            background: #c82333 !important;
            transform: scale(1.1);
        }
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .confirm-yes { background: #28a745; }
        .confirm-no { background: #dc3545; }
        .confirm-yes:hover { background: #218838; }
        .confirm-no:hover { background: #c82333; }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            #lotteryBox { width: 300px !important; height: 300px !important; margin: 30px auto !important; }
            .settings-row, .manual-input-area { flex-direction: column; }
            .button-group { flex-direction: column; }
            .top-controls { right: 10px; top: 10px; }
        }
    </style>
</head>
<body>
    <!-- âœ… éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• & è¨­å®šæŒ‰éˆ• -->
    <div class="top-controls">
        <button id="authorBtn" onclick="showAuthor()">ğŸ‘¨â€ğŸ’» å…è²¬è²æ˜</button>
        <button id="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³æ•ˆé–‹å•Ÿ</button>
        <button id="settingsBtn" onclick="showSettingsDialog()">âš™ï¸ æŠ½çè¨­å®š</button>
    </div>
    
    <div id="topWinner">ğŸ‰ æ­å–œ <span id="winnerName"></span> ç­‰ <span id="winnerCount"></span> äººä¸­çï¼</div>
    
    <h1 id="mainTitle">ğŸ 2025 GIS ç±ƒçƒç¤¾æ­²æœ«å¹´çµ‚æŠ½ç ğŸ</h1>
    
    <div class="main-container">
        <div class="left-panel">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            
            <div class="control-panel">
                <div class="button-group">
                    <button id="manualListBtn" class="confirm-btn" onclick="openManualList()">
                        âœï¸ æ‰‹å‹•è¼¸å…¥åå–®
                    </button>

                    <button id="confirmListBtn" class="confirm-btn" onclick="showConfirmDialog()" disabled>
                        ğŸ“‹ æª¢è¦– / ç¢ºèªåå–®
                    </button>

                    <button id="draw1Btn" class="draw1" onclick="drawMultiple(1)" disabled>ğŸ² æŠ½ 1 å€‹</button>
                    <button id="draw5Btn" class="draw5" onclick="drawMultiple(5)" disabled>âš¡ æŠ½ 5 å€‹</button>
                    <button id="draw30Btn" class="draw30" onclick="drawMultiple(30)" disabled>ğŸ¯ æŠ½ 30 å€‹</button>
                </div>
                <div class="end-group">
                    <button id="finishBtn" onclick="finishDraw()" disabled class="end">ğŸ æŠ½ççµæŸ</button>
                    <button id="resetBtn" onclick="resetDraw()" style="display:none;" class="reset">ğŸ”„ é‡ç½®</button>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
                <div id="lotteryBox">
                    <div class="box-container" id="boxContainer">
                        <div class="box"></div>
                        <div class="box-lid" id="boxLid"></div>
                    </div>
                </div>
            </div>
            
            <div id="currentWinner">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ</div>
            
            <div id="batchWinners">
                <h3>ğŸŠ æœ¬è¼ªä¸­çåå–®ï¼ˆ<span id="batchCount">0</span> äººï¼‰</h3>
                <div id="batchWinnersContent"></div>
            </div>
        </div>
        
        <div class="right-panel">
            <h3>ğŸ“‹ å®Œæ•´ä¸­çåå–®ï¼ˆ<span id="totalWinners">0</span> / <span id="maxWinnersDisplay">30</span> äººï¼‰</h3>
            <div id="winnersList">
                <div id="winnersContent"></div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="exportBtn" onclick="exportWinners()" style="display:none;">ğŸ’¾ åŒ¯å‡ºTXT</button>
            </div>
        </div>
    </div>

    <!-- âœ… æŠ½çè¨­å®šè¦–çª— -->
    <div id="settingsDialog">
        <div class="settings-content">
            <h3 class="settings-title">âš™ï¸ æŠ½çè¨­å®š</h3>
            
            <div class="settings-row">
                <label style="min-width: 100px;">ğŸ¯ æŠ½çä¸Šé™ï¼š</label>
                <input type="number" id="maxWinnersInput" value="30" min="1" max="500" style="flex: 1; max-width: 150px;">
            </div>
            
            <div class="settings-row">
                <label style="min-width: 100px;">ğŸ“ è‡ªè¨‚æ¨™é¡Œï¼š</label>
                <input type="text" id="titleInput" value="2025 GIS ç±ƒçƒç¤¾æ­²æœ«å¹´çµ‚æŠ½ç" maxlength="50" style="flex: 1;">
            </div>
            
            <div class="settings-buttons">
                <button class="settings-yes" onclick="applySettings()" style="padding: 12px 30px; font-size: 16px;">âœ… å¥—ç”¨è¨­å®š</button>
                <button class="settings-no" onclick="closeSettingsDialog()" style="padding: 12px 30px; font-size: 16px;">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- âœ… ç¢ºèªåå–®è¦–çª— -->
    <div id="confirmDialog">
        <div class="confirm-content">
            <h3 style="text-align: center; margin: 0 0 20px 0;">ğŸ“‹ ç¢ºèªåƒåŠ åå–®</h3>
            
            <div class="manual-input-area">
                <input type="text" id="manualInput" placeholder="è¼¸å…¥å§“åæ–°å¢..." maxlength="20">
                <button onclick="addManualParticipant()" class="confirm-yes" style="padding: 12px 20px; font-size: 16px; min-width: 80px;">â• æ–°å¢</button>
            </div>
            
            <div class="confirm-list">
                <div id="confirmListContent"></div>
            </div>
            <div style="text-align: center; font-size: 18px; color: #ffd700; margin: 15px 0;">
                å…± <span id="confirmCount">0</span> äºº
            </div>
            <div class="confirm-buttons">
                <button class="confirm-yes" onclick="confirmList(true)" style="padding: 12px 30px; font-size: 16px;">âœ… ç¢ºèªç„¡èª¤</button>
                <button class="confirm-no" onclick="confirmList(false)" style="padding: 12px 30px; font-size: 16px;">âŒ é‡æ–°ä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script>
        let participants = [];
        let available = [];
        let winners = [];
        let isAnimating = false;
        let isListConfirmed = false;
        let paperCards = [];
        let MAX_WINNERS = 30;  // âœ… å¯å‹•æ…‹è¨­å®š
        
        // âœ… éŸ³æ•ˆç³»çµ±
        let isSoundEnabled = true;
        let shakeAudio, openAudio, cheerAudio;
        
        function loadSounds() {
            shakeAudio = new Audio('4s.mp3');
            shakeAudio.loop = true;
            shakeAudio.volume = 0.8;
            openAudio = new Audio('cymble.mp3');
            openAudio.volume = 0.8;
            cheerAudio = new Audio('YA.mp3');
            cheerAudio.volume = 0.8;
        }
        
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const btn = document.getElementById('soundToggle');
            btn.innerHTML = isSoundEnabled ? 'ğŸ”Š éŸ³æ•ˆé–‹å•Ÿ' : 'ğŸ”‡ éŸ³æ•ˆé—œé–‰';
            btn.classList.toggle('muted');
            if (!isSoundEnabled && shakeAudio) shakeAudio.pause();
        }
        
        function playShakeSound() {
            if (!isSoundEnabled || !shakeAudio) return;
            shakeAudio.currentTime = 0;
            shakeAudio.play().catch(e => {});
        }
        
        function playOpenSound() {
            if (!isSoundEnabled || !openAudio) return;
            openAudio.currentTime = 0;
            openAudio.play().catch(e => {});
        }
        
        function playCheerSound() {
            if (!isSoundEnabled || !cheerAudio) return;
            cheerAudio.currentTime = 0;
            cheerAudio.play().catch(e => {});
        }

        function showAuthor() {
            alert(
                'ğŸ“Œ æŠ½çç³»çµ±å…è²¬è²æ˜\n\n' +
                'æœ¬æŠ½çç³»çµ±ç‚ºæ¸¬è©¦èˆ‡ç¤ºç¯„ç”¨é€”ï¼Œ\n' +
                'æŠ½ççµæœåƒ…ä¾›åƒè€ƒï¼Œä¸å…·ä»»ä½•æ³•å¾‹æ•ˆåŠ›ã€‚\n\n' +
                'é–‹ç™¼è€…ï¼ˆHubert.Kuanï¼‰ä¸ä¿è­‰\n' +
                'ç³»çµ±é‹ä½œä¹‹å®Œæ•´æ€§èˆ‡å³æ™‚æ€§ï¼Œ\n' +
                'äº¦ä¸è² ä»»ä½•çˆ­è­°æˆ–æå¤±ä¹‹è²¬ä»»ã€‚'
            );
        }
        
        // âœ… é¡¯ç¤ºè¨­å®šå°è©±æ¡†
        function showSettingsDialog() {
            document.getElementById('settingsDialog').style.display = 'block';
            document.getElementById('maxWinnersInput').focus();
        }
        
        // âœ… é—œé–‰è¨­å®šå°è©±æ¡†
        function closeSettingsDialog() {
            document.getElementById('settingsDialog').style.display = 'none';
        }
        
        // âœ… å¥—ç”¨è¨­å®š
        function applySettings() {
            const maxInput = document.getElementById('maxWinnersInput');
            const titleInput = document.getElementById('titleInput');
            
            const newMax = parseInt(maxInput.value);
            const newTitle = titleInput.value.trim();
            
            if (newMax < 1 || newMax > 500) {
                alert('è«‹è¼¸å…¥ 1-500 äººä¹‹é–“çš„æ•¸å­—ï¼');
                return;
            }
            if (!newTitle) {
                alert('è«‹è¼¸å…¥æ¨™é¡Œï¼');
                return;
            }
            
            MAX_WINNERS = newMax;
            document.title = newTitle;
            document.getElementById('mainTitle').textContent = newTitle;
            document.getElementById('maxWinnersDisplay').textContent = MAX_WINNERS;
            
            updateUI();
            closeSettingsDialog();
            alert(`âœ… è¨­å®šå·²æ›´æ–°ï¼\næŠ½çä¸Šé™ï¼š${MAX_WINNERS} äºº\næ¨™é¡Œï¼š${newTitle}`);
        }

        function openManualList() {
            // å¦‚æœå·²ç¶“ç¢ºèªåå–®ï¼Œå…ˆæé†’
            if (isListConfirmed) {
                if (!confirm('åå–®å·²ç¢ºèªï¼Œé‡æ–°ç·¨è¼¯æœƒæ¸…ç©ºæŠ½ççµæœï¼Œç¢ºå®šè¦ç·¨è¼¯å—ï¼Ÿ')) {
                    return;
                }
                winners = [];
                isListConfirmed = false;
                resetAvailable();
                updateWinnersList();
            }

            // æ¸…ç©ºæª”æ¡ˆé¸æ“‡ï¼ˆä»£è¡¨æ‰‹å‹•æ¨¡å¼ï¼‰
            document.getElementById('fileInput').value = '';

            showConfirmDialog();
            updateUI();
        }

        
        // âœ… åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadSounds();
            document.getElementById('maxWinnersDisplay').textContent = MAX_WINNERS;
        });

        // âœ… çµ•å°ä¸é‡è¤‡çš„ available é‡å»º
        function resetAvailable() {
            available = [];
            const winnerNames = new Set(winners);
            
            for (let i = 0; i < participants.length; i++) {
                if (!winnerNames.has(participants[i].name)) {
                    available.push(i);
                }
            }
            console.log(`âœ… é‡å»º available: ${available.length} äººå¯æŠ½ (æ’é™¤ ${winners.length}/${MAX_WINNERS} ä¸­çè€…)`);
        }

        // âœ… ç¢ºèªåå–®è¦–çª—
        function showConfirmDialog() {
            const dialog = document.getElementById('confirmDialog');
            const listContent = document.getElementById('confirmListContent');
            const confirmCount = document.getElementById('confirmCount');

            listContent.innerHTML = participants.length === 0
                ? '<div style="text-align:center; color:#ffd700;">ç›®å‰å°šç„¡åå–®ï¼Œè«‹æ‰‹å‹•æ–°å¢</div>'
                : participants.map((p, idx) => 
                    `<div class="confirm-item">
                        <span>${idx + 1}. ${p.name}</span>
                        <button class="confirm-delete-btn" onclick="deleteConfirmParticipant(${idx})">âŒ</button>
                    </div>`
                ).join('');

            confirmCount.textContent = participants.length;
            dialog.style.display = 'block';
            document.getElementById('manualInput').focus();
        }

        // âœ… æ‰‹å‹•æ–°å¢
        function addManualParticipant() {
            const input = document.getElementById('manualInput');
            const name = input.value.trim();
            
            if (!name) {
                alert('è«‹è¼¸å…¥å§“åï¼');
                input.focus();
                return;
            }
            
            if (participants.find(p => p.name === name)) {
                alert('æ­¤å§“åå·²å­˜åœ¨ï¼');
                input.value = '';
                input.focus();
                return;
            }
            
            participants.push({name: name});
            resetAvailable();
            input.value = '';
            showConfirmDialog();
        }

        // âœ… Enteréµæ–°å¢
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('confirmDialog').style.display !== 'none') {
                addManualParticipant();
            }
        });

        // âœ… åˆªé™¤ç¢ºèªåå–®
        function deleteConfirmParticipant(index) {
            const name = participants[index].name;
            if (confirm(`ç¢ºå®šè¦å¾åå–®ä¸­åˆªé™¤ "${name}" å—ï¼Ÿ`)) {
                participants.splice(index, 1);
                resetAvailable();
                showConfirmDialog();
            }
        }

        // âœ… ç¢ºèªåå–®
        function confirmList(isConfirmed) {
            document.getElementById('confirmDialog').style.display = 'none';

            if (isConfirmed) {
                if (participants.length === 0) {
                    alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½æŠ½çäººï¼');
                    showConfirmDialog();
                    return;
                }

                isListConfirmed = true;
                resetAvailable();
                alert(`âœ… åå–®ç¢ºèªå®Œæˆï¼å…± ${participants.length} äºº\næŠ½çä¸Šé™ï¼š${MAX_WINNERS} äºº`);
                updateUI();
            } else {
                document.getElementById('fileInput').value = '';
                participants = [];
                available = [];
                winners = [];
                isListConfirmed = false;
                updateUI();
                alert('è«‹é‡æ–°è¨­å®šåå–®');
            }
        }

        document.getElementById('confirmDialog').addEventListener('click', function(e) {
            if (e.target.id === 'confirmDialog') {
                this.style.display = 'none';
            }
        });

        document.getElementById('settingsDialog').addEventListener('click', function(e) {
            if (e.target.id === 'settingsDialog') {
                closeSettingsDialog();
            }
        });

        // âœ… æª”æ¡ˆä¸Šå‚³
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                
                participants = [];
                for (let i = 1; i < json.length; i++) {
                    if (json[i] && json[i][0]) {
                        const name = json[i][0].toString().trim();
                        if (name) participants.push({name: name});
                    }
                }
                
                // å»é‡
                participants = participants.filter((p, index, self) =>
                    index === self.findIndex(t => t.name === p.name)
                );
                
                console.log('è®€å–å®Œæˆï¼Œå…±', participants.length, 'äºº');
                isListConfirmed = false;
                resetAvailable();
                updateUI();
                showConfirmDialog();
            };
            reader.readAsArrayBuffer(file);
        });

        // âœ… é˜²é‡è¤‡æŠ½çæ ¸å¿ƒ
        function drawMultiple(requestedCount) {
            if (!isListConfirmed) {
                alert('è«‹å…ˆç¢ºèªåå–®ï¼');
                return;
            }
            if (available.length === 0) {
                alert('âŒ ç„¡äººå¯æŠ½ï¼');
                return;
            }

            const remainingSlots = MAX_WINNERS - winners.length;
            const actualCount = Math.min(requestedCount, available.length, remainingSlots);
            
            if (actualCount === 0) {
                alert(`å·²é”ä¸Šé™ ${MAX_WINNERS} äººï¼`);
                return;
            }

            console.log(`ğŸ² æŠ½çï¼šè«‹æ±‚${requestedCount}ï¼Œå¯¦éš›${actualCount}ï¼Œå‰©é¤˜${available.length}`);
            isAnimating = true;
            disableButtons();
            
            let batchWinners = [];
            const drawnNames = new Set();
            
            for (let i = 0; i < actualCount; i++) {
                if (available.length === 0) break;
                
                const randomIdx = Math.floor(Math.random() * available.length);
                const winnerIdx = available[randomIdx];
                const winnerName = participants[winnerIdx].name;
                
                if (winnerIdx >= 0 && winnerIdx < participants.length && 
                    !drawnNames.has(winnerName) && !winners.includes(winnerName)) {
                    
                    batchWinners.push(winnerName);
                    drawnNames.add(winnerName);
                    available.splice(randomIdx, 1);
                }
            }
            
            if (batchWinners.length > 0) {
                shakeAndBatchFly(batchWinners, requestedCount);
            } else {
                alert('æŠ½çå¤±æ•—ï¼Œè«‹é‡è©¦ï¼');
                isAnimating = false;
                updateUI();
            }
        }

        function shakeAndBatchFly(batchWinners, requestedCount) {
            const boxContainer = document.getElementById('boxContainer');
            const boxLid = document.getElementById('boxLid');
            
            boxContainer.classList.add('shaking');
            boxLid.classList.add('shaking-lid');
            document.getElementById('currentWinner').innerHTML = 'ğŸŒ€ ç®±å­æ”ªå‹•ä¸­...';
            playShakeSound();
            
            setTimeout(() => {
                boxContainer.classList.remove('shaking');
                boxLid.classList.remove('shaking-lid');
                if (shakeAudio) shakeAudio.pause();
                
                boxLid.classList.add('opening');
                document.getElementById('currentWinner').innerHTML = 'â¬†ï¸ ç®±è“‹é–‹å•Ÿä¸­...';
                playOpenSound();
                
                setTimeout(() => {
                    batchPaperFlyOut(batchWinners, () => {
                        document.getElementById('currentWinner').innerHTML = `ğŸ‰ æŠ½çå®Œæˆï¼å…±${batchWinners.length}äººä¸­ç`;
                        
                        setTimeout(() => {
                            boxLid.classList.remove('opening');
                            paperCards.forEach(card => card.remove());
                            paperCards = [];
                            
                            winners.push(...batchWinners);
                            showBatchWinners(batchWinners, batchWinners.length, requestedCount);
                            updateWinnersList();
                            playCheerSound();
                            showTopWinner(batchWinners, batchWinners.length);
                            isAnimating = false;
                            updateUI(true);
                            enableButtons();
                        }, 2000);
                    });
                }, 1500);
            }, 4000);
        }

        function batchPaperFlyOut(batchWinners, callback) {
            const lotteryBox = document.getElementById('lotteryBox');
            paperCards.forEach(card => card.remove());
            paperCards = [];
            
            batchWinners.forEach((name, index) => {
                const card = document.createElement('div');
                card.className = 'nameCard';
                card.textContent = name;
                card.style.left = '50%';
                card.style.top = '50%';
                card.style.setProperty('--x-offset', `${(Math.random() - 0.5) * 300 + (index % 3 - 1) * 40}px`);
                card.style.setProperty('--y-offset', `${-150 - index * 15 + (Math.random() - 0.5) * 80}px`);
                card.style.animationDelay = `${index * 0.1}s`;
                card.style.zIndex = 100 + index;
                
                lotteryBox.appendChild(card);
                paperCards.push(card);
                card.classList.add('fly-out-batch');
            });
            
            setTimeout(callback, 2000);
        }

        function showTopWinner(winnerNames, count) {
            document.getElementById('winnerName').textContent = winnerNames[0];
            document.getElementById('winnerCount').textContent = count;
            document.getElementById('topWinner').style.display = 'block';
            setTimeout(() => {
                document.getElementById('topWinner').style.display = 'none';
            }, 4000);
        }

        function showBatchWinners(batchWinners, actualCount, requestedCount) {
            document.getElementById('batchCount').textContent = `${actualCount} äºº`;
            document.getElementById('batchWinnersContent').innerHTML = 
                batchWinners.map((name, idx) => 
                    `<div class="batch-winner">ğŸ‰ ${winners.length - batchWinners.length + idx + 1}. ${name}</div>`
                ).join('');
            document.getElementById('batchWinners').style.display = 'block';
            document.getElementById('batchWinners').scrollTop = 0;
        }

        function updateWinnersList() {
            document.getElementById('totalWinners').textContent = winners.length;
            document.getElementById('winnersContent').innerHTML = 
                winners.map((name, idx) => 
                    `<div class="winner-item removeable" data-index="${idx}">
                        <span>${idx+1}. ${name}</span>
                        <button class="remove-btn" onclick="removeWinner(${idx})">ç§»é™¤</button>
                    </div>`
                ).join('');
        }

        // âœ… ç§»é™¤ä¸­çè€… - å®Œå…¨é‡å»º
        function removeWinner(index) {
            if (index < 0 || index >= winners.length) return;
            winners.splice(index, 1);
            resetAvailable();
            updateWinnersList();
            updateUI();
            document.getElementById('batchWinners').style.display = 'none';
        }

        function exportWinners() {
            if (winners.length === 0) {
                alert('æ²’æœ‰ä¸­çåå–®å¯åŒ¯å‡ºï¼');
                return;
            }
            
            let txtContent = `${document.getElementById('mainTitle').textContent}\n`;
            txtContent += `æŠ½ççµæœ - å…± ${winners.length}/${MAX_WINNERS} äººä¸­ç\n`;
            txtContent += `========================\n\n`;
            
            winners.forEach((name, idx) => {
                txtContent += `${String(idx + 1).padStart(2, ' ')}. ${name}\n`;
            });
            
            txtContent += `\n========================\n`;
            txtContent += `ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n`;
            
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æŠ½ççµæœ_${new Date().toISOString().slice(0,10)}.txt`;
            link.click();
        }

        function updateUI() {
            const draw1Btn = document.getElementById('draw1Btn');
            const draw5Btn = document.getElementById('draw5Btn');
            const draw30Btn = document.getElementById('draw30Btn');
            const confirmListBtn = document.getElementById('confirmListBtn');
            const finishBtn = document.getElementById('finishBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            const isFinished = winners.length >= MAX_WINNERS;
            const canDraw = participants.length > 0 && available.length > 0 && !isAnimating && !isFinished && isListConfirmed;
            const hasParticipants = participants.length > 0;
            
            draw1Btn.disabled = !canDraw;
            draw5Btn.disabled = !canDraw;
            draw30Btn.disabled = !canDraw;
            confirmListBtn.disabled = isListConfirmed;
            document.getElementById('manualListBtn').disabled = isAnimating;
            finishBtn.disabled = winners.length === 0 || isFinished;
            exportBtn.style.display = winners.length > 0 ? 'inline-block' : 'none';
            
            document.getElementById('resetBtn').style.display = isFinished ? 'inline-block' : 'none';
            
            document.getElementById('currentWinner').innerHTML = 
                isFinished ? `ğŸ‰ å·²æŠ½æ»¿ ${MAX_WINNERS} äººï¼ŒæŠ½çå®Œæˆï¼` :
                !hasParticipants ? 'è«‹å…ˆä¸Šå‚³æª”æ¡ˆ' :
                !isListConfirmed ? `ğŸ“‹ å·²è®€å– ${participants.length} äººï¼Œè«‹ç¢ºèªåå–®` :
                `âœ… å·²ç¢ºèª ${participants.length} äººï¼Œå‰©é¤˜ ${available.length} äººï¼ˆå·²æŠ½ ${winners.length}/${MAX_WINNERS} äººï¼‰`;
        }

        function finishDraw() {
            document.getElementById('batchWinners').style.display = 'none';
            updateWinnersList();
        }

        function disableButtons() {
            document.getElementById('draw1Btn').disabled = true;
            document.getElementById('draw5Btn').disabled = true;
            document.getElementById('draw30Btn').disabled = true;
        }

        function enableButtons() {
            updateUI();
        }

        function resetDraw() {
            isAnimating = false;
            isListConfirmed = false;
            if (shakeAudio) shakeAudio.pause();
            resetAvailable();
            document.getElementById('resetBtn').style.display = 'none';
            document.getElementById('batchWinners').style.display = 'none';
            document.getElementById('topWinner').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('boxContainer').classList.remove('shaking');
            document.getElementById('boxLid').classList.remove('shaking-lid', 'opening');
            paperCards.forEach(card => card.remove());
            paperCards = [];
            updateUI();
        }
    </script>
</body>
</html>
